<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition template="../template/application.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui">

    <ui:define name="title">
        <h:outputText value="#{messages.getString('productEntity')}"/>
    </ui:define>
    <ui:define name="headerMenu"/>
    <!--TODO add privs and labels -->
    <ui:define name="body">
        <h:form id="mainForm">
            <h:outputText value="#{messages.getString('productEntity')}" styleClass="listTitle"/>
            <br/>

            <p:growl id="growl" showDetail="true"/>


            <h:panelGroup id="buttons">

                <p:commandButton value="#{messages.getString('button.save')}"
                                 action="#{productScreen.save}"
                                 onclick="this.disabled=true"
                                 oncomplete="this.disabled=false"
                                 update=":mainForm"
                                 styleClass="btn"/>
                <p:commandButton update=":mainForm:entities, :mainForm:calcsPG, :mainForm:growl"
                                 action="#{productScreen.calculate}"
                                 title="#{messages.getString('button.calc.calculate')}"
                                 value="#{messages.getString('button.calc.calculate')}"
                                 styleClass="btn">
                </p:commandButton>
                <br/>
                <p:commandButton update=":mainForm:entities"
                                 title="Добавить деталь"
                                 action="#{productScreen.addProduct}"
                                 value="#{messages.getString('button.calc.addProduct')}"
                                 disabled="#{productScreen.selectedNode == null}"
                                 styleClass="btn"/>
                <p:commandButton value="#{messages.getString('button.calc.addTNC')}"
                                 title="Добавить ТМЦ"
                                 actionListener="#{productScreen.choose('selectTNC')}"
                                 disabled="#{productScreen.selectedNode == null}"
                                 styleClass="btn">
                    <p:ajax event="dialogReturn"
                            listener="#{productScreen.onTNCChosen}"
                            update=":mainForm:entities"/>
                </p:commandButton>

                <p:commandButton value="#{messages.getString('button.calc.addWork')}"
                                 title="Добавить работу"
                                 actionListener="#{productScreen.choose('selectWork')}"
                                 disabled="#{productScreen.selectedNode == null}"
                                 styleClass="btn">
                    <p:ajax event="dialogReturn"
                            listener="#{productScreen.onWorkChosen}"
                            update=":mainForm:entities"/>
                </p:commandButton>
                <p:commandButton value="#{messages.getString('button.calc.addFunction')}"
                                 title="Добавить функцию"
                                 actionListener="#{productScreen.choose('selectFunction')}"
                                 disabled="#{productScreen.selectedNode == null}"
                                 styleClass="btn">
                    <p:ajax event="dialogReturn"
                            listener="#{productScreen.onFunctionChosen}"
                            update=":mainForm:entities"/>
                </p:commandButton>
                <p:commandButton update=":mainForm:entities, :mainForm:buttons, :mainForm:growl"
                                 action="#{productScreen.delete}"
                                 title="#{messages.getString('button.delete')}"
                                 value="#{messages.getString('button.delete')}"
                                 disabled="#{productScreen.selectedNode.data.parent == null}"
                                 styleClass="btn">
                    <p:confirm header="#{messages.getString('button.delete.confirmation')}"
                               message="#{messages.getString('button.delete.message')}"
                               icon="ui-icon-alert"/>
                </p:commandButton>

                <p:commandButton value="#{messages.getString('button.change')}"
                                 title="#{messages.getString('button.change')}"
                                 actionListener="#{productScreen.choose()}"
                                 rendered="#{productScreen.isSelectable()}"
                                 styleClass="btn">
                    <p:ajax event="dialogReturn"
                            listener="#{productScreen.onChosen}"
                            update=":mainForm:entities"/>
                </p:commandButton>

            </h:panelGroup>
            <p:treeTable id="entities"
                         value="#{productScreen.root}"
                         var="product"
                         nodeVar="node"
                         editable="true"
                         editMode="cell"
                         selectionMode="single"
                         resizableColumns="true"
                         selection="#{productScreen.selectedNode}"
                    >

                <p:ajax event="select" update=":mainForm:buttons"/>

                <p:column headerText="#{messages.getString('productEntity.name')}"
                          style="width:450px">
                    <p:cellEditor>
                        <f:facet name="output">
                            <span style="display: inline-block; width: 100%; height: 100%">
                                &zwnj;
                                <h:outputText value="#{product.name}"/>
                            </span>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{product.name}"
                                         disabled="#{productScreen.isSelectable(product)}"
                                         style="width:100%"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>
                <p:column headerText="#{messages.getString('productEntity.width')}"
                          style="width:60px">
                    <p:cellEditor>
                        <f:facet name="output">
                            <span style="display: inline-block; width: 100%; height: 100%">
                                &zwnj;
                                <h:outputText value="#{product.width}"/>
                            </span>
                        </f:facet>
                        <f:facet name="input"><p:inputNumber value="#{product.width}" style="width:100%"/></f:facet>
                    </p:cellEditor>
                </p:column>
                <p:column headerText="#{messages.getString('productEntity.height')}"
                          style="width:60px">
                    <p:cellEditor>
                        <f:facet name="output">
                            <span style="display: inline-block; width: 100%; height: 100%">
                                &zwnj;
                                <h:outputText value="#{product.height}"/>
                            </span>
                        </f:facet>
                        <f:facet name="input"><p:inputNumber value="#{product.height}" style="width:100%"/></f:facet>
                    </p:cellEditor>
                </p:column>
                <p:column headerText="#{messages.getString('productEntity.length')}"
                          style="width:60px">
                    <p:cellEditor>
                        <f:facet name="output">
                            <span style="display: inline-block; width: 100%; height: 100%">
                                &zwnj;
                                <h:outputText value="#{product.length}"/>
                            </span>
                        </f:facet>
                        <f:facet name="input"><p:inputNumber value="#{product.length}" style="width:100%"/></f:facet>
                    </p:cellEditor>
                </p:column>
                <p:column headerText="#{messages.getString('productEntity.detail')}">
                    <p:cellEditor>
                        <f:facet name="output">
                            <span style="display: inline-block; width: 100%; height: 100%">
                                &zwnj;
                                <h:outputText value="#{product.detail}"/>
                            </span>
                        </f:facet>
                        <f:facet name="input"><p:inputText value="#{product.detail}" style="width:100%"/></f:facet>
                    </p:cellEditor>
                </p:column>
                <p:column headerText="#{messages.getString('productEntity.formula')}"
                          styleClass="#{productScreen.isError(product) ? 'errorColumn' : ''}">
                    <p:cellEditor>
                        <f:facet name="output">
                            <span style="display: inline-block; width: 100%; height: 100%">
                                &zwnj;
                                <h:outputText value="#{product.formula}"
                                        />
                            </span>
                        </f:facet>
                        <f:facet name="input"><p:inputText value="#{product.formula}" style="width:100%"/></f:facet>
                    </p:cellEditor>
                </p:column>
                <p:column rendered="#{false and productScreen.hasErrors()}">

                    <h:outputText value="#{productScreen.errorProducts[product]}"/>

                </p:column>
            </p:treeTable>

            <h:panelGroup id="calcsPG">

                <h:panelGroup rendered="#{productScreen.rootCalc != null}">
                    <HR/>
                    <h:outputText value="#{messages.getString('productScreen.calculation')}" styleClass="listTitle"/>
                </h:panelGroup>
                <p:treeTable id="calcs"
                             value="#{productScreen.rootCalc}"
                             var="calc"
                             rendered="#{productScreen.rootCalc != null}"
                             style="width: 550px">
                    <p:column headerText="#{messages.getString('productEntity.name')}"
                              style="width:450px">
                        <h:outputText value="#{calc.name}"/>
                    </p:column>
                    <p:column headerText="#{messages.getString('productEntity.price')}"
                              style="width:100px">
                        <h:outputText value="#{calc.price}"/>
                    </p:column>

                </p:treeTable>
            </h:panelGroup>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                <p:commandButton value="Да" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check"/>
                <p:commandButton value="Нет" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close"/>
            </p:confirmDialog>

        </h:form>
    </ui:define>
</ui:composition>
